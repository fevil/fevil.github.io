---
id: 217
title: 'iptables &#8211; разворачиваем межсетевой экран.'
author: fevil
layout: post
guid: http://fevil.org.ru/?p=217
permalink: /?p=217
robotsmeta:
  - index,follow
post_views_count:
  - 1
categories:
  - Linux
tags:
  - Debian
  - Linux
  - Network
  - ubuntu
  - Песочница
---
<p style="text-align: justify;">
  Межсетевой экран представляет собой своеобразную прослойку между локальным ресурсом и внешними подключениями, которая позволяет, отсечь большое количество ненужных нам соединений. Рассмотрим базовые действия, необходимые для развертывания межсетевого экрана в операционной системе Debian GNU Linux.
</p>

<p style="text-align: justify;">
  <!--more-->Отдельной программы межсетевого экрана как таковой мы не найдем, само же управление сетевым трафиком происходит в ядре Linux, подсистемой netfilter.  Создав набор правил, обрабатывающих входящие и исходящие пакеты, мы получим межсетевой экран. Для создания правил ядра, по обработке сетевых пакетов, необходим некий интерфейс пользователя, самым популярным из них является утилита iptables. В дистрибутиве Debian она устанавливается вместе с системой (даже в самой минимальной установке), как впрочем и во многих иных дистрибутивах.
</p>

<p style="text-align: justify;">
  Правила можно добавлять непосредственно из командной строки, действовать они будут либо до перезагрузки системы, либо до отмены их другим правилом. Удобно это на этапе отладки или изучения действия одного либо другого правила. При построении межсетевого экрана, постепенно, количество правил достигает нескольких десятков, поэтому было не плохо сохранять набор правил после каждого изменения. Утилита iptables-save позволяет сделать дамп сиюминутного состояния правил, который можно позднее загрузить утилитой iptables-restore.
</p>

<p style="text-align: justify;">
  Итак после небольшого введения приступим к созданию межсетевого экрана. В Debian GNU Linux нет отдельно сценария запуска межсетевого экрана, как в других дистрибутивах. Поэтому первым делом создадим скрипт первичной инициализации правил межсетевого экрана fw.sh, его можно будет использовать как шаблон. Следующим шагом, добавим несколько строк в файл конфигурации сети, чтобы правила  межсетевого экрана срабатывали вместе с инициализацией сетевых подключений.
</p>

<p style="text-align: justify;">
  Начнем со скрипта. Ниже приведен файл с минимальным набором правил, который отсекает все подключения из-вне к нашему узлу, кроме доступа по ssh. Никаких  ограничений на исходящие соединения не накладывается.
</p>

<p style="padding-left: 180px;">
  #!/bin/bash
</p>

<p style="padding-left: 180px;">
  #fw.sh
</p>

<p style="padding-left: 180px;">
  IP=/sbin/iptables
</p>

<p style="padding-left: 180px;">
  $IP -A INPUT -d $EXT_IP -p tcp &#8211;destination-port 22 -j ACCEPT
</p>

<p style="padding-left: 180px;">
  $IP -A INPUT -m conntrack &#8211;ctstate ESTABLISHED,RELATED -j ACCEPT
</p>

<p style="padding-left: 180px;">
  $IP -P INPUT  DROP
</p>

<p style="padding-left: 180px;">
  $IP -P OUTPUT  ACCEPT
</p>

<p style="text-align: justify;">
  После создания скрипта необходимо сделать его исполняемым и выполнить. Сохраним дамп полученных правил межсетевого экрана, в файл /etc/fw-saved,  командой:
</p>

<p style="padding-left: 180px; text-align: justify;">
  iptables-save > /etc/fw-saved
</p>

<p style="text-align: justify;">
  Это действие необходимо выполнять каждый раз, после добавления нового правила из консоли. Теперь у нас есть набор правил, который будет актуальным до перезагрузки, добавим следующую запись в /etc/network/interfaces, в самом низу описания интерфейса через который подключаемся к интернету:
</p>

<p style="text-align: justify; padding-left: 180px;">
  up /sbin/iptables-restore < /etc/fw-saved
</p>

<p style="text-align: justify;">
  Это действие, приведет, к автоматической инициализации правил межсетевого экрана при старте сетевого демона.
</p>

<p style="text-align: justify;">
  Выше мы рассмотрели основные принципы построения межсетевого экрана, с помощью утилиты iptables. На самом  деле её возможности по управлению трафиком очень обширны и хорошо изложены в классическом <a title="труде" href="http://www.opennet.ru/docs/RUS/iptables/" target="_blank">труде</a>, который должен быть настольной книгой любого администратора.
</p>

&nbsp;

<p style="padding-left: 90px;">
  &nbsp;
</p>

&nbsp;